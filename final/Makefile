# Event-Driven K3s-DaaS Makefile
# ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë°°í¬ ìë™í™”

.PHONY: build test clean deploy setup deps lint

# ê¸°ë³¸ ì„¤ì •
BINARY_DIR=../bin
GATEWAY_BINARY=$(BINARY_DIR)/contract-api-gateway
LISTENER_BINARY=$(BINARY_DIR)/nautilus-event-listener

# Go ë¹Œë“œ í”Œë˜ê·¸
GO_BUILD_FLAGS=-v -ldflags "-s -w"
GO_TEST_FLAGS=-v -race -coverprofile=coverage.out

# ì˜ì¡´ì„± ì„¤ì¹˜
deps:
	@echo "ğŸ“¦ Installing Go dependencies..."
	go mod tidy
	go mod download
	@echo "âœ… Dependencies installed"

# ë°”ì´ë„ˆë¦¬ ë¹Œë“œ
build: deps
	@echo "ğŸ”¨ Building binaries..."
	mkdir -p $(BINARY_DIR)
	go build $(GO_BUILD_FLAGS) -o $(GATEWAY_BINARY) contract_api_gateway.go
	go build $(GO_BUILD_FLAGS) -o $(LISTENER_BINARY) nautilus_event_listener.go
	@echo "âœ… Build completed"
	@echo "   API Gateway: $(GATEWAY_BINARY)"
	@echo "   Event Listener: $(LISTENER_BINARY)"

# ê°œë°œìš© ë¹ ë¥¸ ë¹Œë“œ
build-dev:
	@echo "ğŸš€ Quick development build..."
	go build -o api-gateway contract_api_gateway.go
	go build -o nautilus-listener nautilus_event_listener.go
	@echo "âœ… Development build completed"

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
test:
	@echo "ğŸ§ª Running tests..."
	go test $(GO_TEST_FLAGS) ./...
	@echo "ğŸ“Š Test coverage:"
	go tool cover -func=coverage.out
	@echo "âœ… Tests completed"

# ì½”ë“œ ë¦°íŒ…
lint:
	@echo "ğŸ” Running code linting..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo "âš ï¸ golangci-lint not installed, using go vet"; \
		go vet ./...; \
	fi
	@echo "âœ… Linting completed"

# Move Contract í…ŒìŠ¤íŠ¸
test-contract:
	@echo "â›“ï¸ Testing Move contracts..."
	cd ../contracts-release && sui move test
	@echo "âœ… Contract tests completed"

# ì „ì²´ í…ŒìŠ¤íŠ¸ (Go + Move)
test-all: test test-contract
	@echo "ğŸ¯ All tests completed"

# í™˜ê²½ ì„¤ì • í™•ì¸
setup:
	@echo "ğŸ“‹ Checking environment setup..."
	@echo "Go version: $$(go version)"
	@echo "Sui CLI: $$(sui --version 2>/dev/null || echo 'Not installed')"
	@echo "kubectl: $$(kubectl version --client --short 2>/dev/null || echo 'Not installed')"
	@echo "Docker: $$(docker --version 2>/dev/null || echo 'Not installed')"
	@echo "âœ… Environment check completed"

# ë¡œê·¸ íŒŒì¼ ì •ë¦¬
clean-logs:
	@echo "ğŸ§¹ Cleaning log files..."
	rm -f *.log *.pid
	rm -f ../contracts-release/*.log
	rm -f ../nautilus-release/*.log
	rm -f ../worker-release/*.log
	@echo "âœ… Log files cleaned"

# ë°”ì´ë„ˆë¦¬ ì •ë¦¬
clean-bin:
	@echo "ğŸ§¹ Cleaning binaries..."
	rm -rf $(BINARY_DIR)
	rm -f api-gateway nautilus-listener
	@echo "âœ… Binaries cleaned"

# ì „ì²´ ì •ë¦¬
clean: clean-logs clean-bin
	@echo "ğŸ§¹ Cleaning all generated files..."
	rm -f coverage.out
	rm -f *.json *.yaml *.txt
	go clean -cache
	@echo "âœ… Clean completed"

# í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
integration-test:
	@echo "ğŸš€ Running integration test..."
	chmod +x 5_STEP_INTEGRATION_TEST.sh
	./5_STEP_INTEGRATION_TEST.sh
	@echo "âœ… Integration test completed"

# ê°œë°œ ì„œë²„ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
dev-start: build-dev
	@echo "ğŸŒŸ Starting development servers..."
	@echo "Starting API Gateway..."
	./api-gateway > api-gateway.log 2>&1 &
	@echo $$! > api-gateway.pid
	@sleep 3
	@echo "Starting Nautilus Event Listener..."
	./nautilus-listener > nautilus-listener.log 2>&1 &
	@echo $$! > nautilus-listener.pid
	@sleep 3
	@echo "âœ… Development servers started"
	@echo "   API Gateway PID: $$(cat api-gateway.pid)"
	@echo "   Event Listener PID: $$(cat nautilus-listener.pid)"
	@echo "   Logs: tail -f *.log"

# ê°œë°œ ì„œë²„ ì¤‘ì§€
dev-stop:
	@echo "ğŸ›‘ Stopping development servers..."
	@if [ -f api-gateway.pid ]; then \
		kill $$(cat api-gateway.pid) 2>/dev/null || true; \
		rm -f api-gateway.pid; \
		echo "API Gateway stopped"; \
	fi
	@if [ -f nautilus-listener.pid ]; then \
		kill $$(cat nautilus-listener.pid) 2>/dev/null || true; \
		rm -f nautilus-listener.pid; \
		echo "Event Listener stopped"; \
	fi
	@echo "âœ… Development servers stopped"

# ê°œë°œ ì„œë²„ ì¬ì‹œì‘
dev-restart: dev-stop clean-logs dev-start
	@echo "ğŸ”„ Development servers restarted"

# ìƒíƒœ í™•ì¸
status:
	@echo "ğŸ“Š System status:"
	@if [ -f api-gateway.pid ] && kill -0 $$(cat api-gateway.pid) 2>/dev/null; then \
		echo "âœ… API Gateway: Running (PID: $$(cat api-gateway.pid))"; \
	else \
		echo "âŒ API Gateway: Not running"; \
	fi
	@if [ -f nautilus-listener.pid ] && kill -0 $$(cat nautilus-listener.pid) 2>/dev/null; then \
		echo "âœ… Event Listener: Running (PID: $$(cat nautilus-listener.pid))"; \
	else \
		echo "âŒ Event Listener: Not running"; \
	fi
	@echo "Ports:"
	@echo "  - API Gateway: http://localhost:8080"
	@echo "  - Event Listener: http://localhost:10250"

# ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸
logs:
	@echo "ğŸ“„ Showing recent logs..."
	@echo "=== API Gateway Logs ==="
	@tail -20 api-gateway.log 2>/dev/null || echo "No API Gateway logs"
	@echo ""
	@echo "=== Event Listener Logs ==="
	@tail -20 nautilus-listener.log 2>/dev/null || echo "No Event Listener logs"

# ë¡œê·¸ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼
logs-follow:
	@echo "ğŸ“„ Following logs (Ctrl+C to stop)..."
	tail -f api-gateway.log nautilus-listener.log

# í—¬ìŠ¤ì²´í¬
health:
	@echo "ğŸ¥ Health check..."
	@echo "API Gateway:"
	@curl -s http://localhost:8080/healthz || echo "  âŒ API Gateway not responding"
	@echo ""
	@echo "Event Listener:"
	@curl -s http://localhost:10250/health || echo "  âŒ Event Listener not responding"

# kubectl ì„¤ì •
setup-kubectl:
	@echo "âš™ï¸ Setting up kubectl for K3s-DaaS..."
	kubectl config set-cluster k3s-daas \
		--server=http://localhost:8080 \
		--insecure-skip-tls-verify=true
	kubectl config set-credentials k3s-daas-user \
		--token="seal_test_token_$(shell date +%s)"
	kubectl config set-context k3s-daas \
		--cluster=k3s-daas \
		--user=k3s-daas-user
	kubectl config use-context k3s-daas
	@echo "âœ… kubectl configured for K3s-DaaS"

# ë¹ ë¥¸ í…ŒìŠ¤íŠ¸
quick-test: dev-start
	@echo "âš¡ Quick functionality test..."
	@sleep 5
	@echo "Testing API Gateway..."
	@curl -s http://localhost:8080/healthz || echo "API Gateway test failed"
	@echo "Testing Event Listener..."
	@curl -s http://localhost:10250/health || echo "Event Listener test failed"
	@echo "âœ… Quick test completed"

# í”„ë¡œë•ì…˜ ë¹Œë“œ
build-prod:
	@echo "ğŸ­ Production build..."
	CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo $(GO_BUILD_FLAGS) -o $(GATEWAY_BINARY) contract_api_gateway.go
	CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo $(GO_BUILD_FLAGS) -o $(LISTENER_BINARY) nautilus_event_listener.go
	@echo "âœ… Production build completed"

# Docker ì´ë¯¸ì§€ ë¹Œë“œ (í–¥í›„)
docker-build:
	@echo "ğŸ³ Building Docker images..."
	@echo "TODO: Implement Docker build"

# ë„ì›€ë§
help:
	@echo "ğŸ“‹ Available commands:"
	@echo ""
	@echo "ğŸ”¨ Build commands:"
	@echo "  make build          - Build production binaries"
	@echo "  make build-dev      - Quick development build"
	@echo "  make build-prod     - Production build with optimizations"
	@echo ""
	@echo "ğŸ§ª Test commands:"
	@echo "  make test           - Run Go unit tests"
	@echo "  make test-contract  - Run Move contract tests"
	@echo "  make test-all       - Run all tests"
	@echo "  make integration-test - Run full integration test"
	@echo ""
	@echo "ğŸŒŸ Development commands:"
	@echo "  make dev-start      - Start development servers"
	@echo "  make dev-stop       - Stop development servers"
	@echo "  make dev-restart    - Restart development servers"
	@echo "  make quick-test     - Quick functionality test"
	@echo ""
	@echo "ğŸ“Š Monitoring commands:"
	@echo "  make status         - Show system status"
	@echo "  make health         - Run health checks"
	@echo "  make logs           - Show recent logs"
	@echo "  make logs-follow    - Follow logs in real-time"
	@echo ""
	@echo "ğŸ§¹ Maintenance commands:"
	@echo "  make clean          - Clean all generated files"
	@echo "  make clean-logs     - Clean log files only"
	@echo "  make clean-bin      - Clean binaries only"
	@echo ""
	@echo "âš™ï¸ Setup commands:"
	@echo "  make setup          - Check environment setup"
	@echo "  make deps           - Install dependencies"
	@echo "  make setup-kubectl  - Configure kubectl"
	@echo "  make lint           - Run code linting"

# ê¸°ë³¸ íƒ€ê²Ÿ
all: clean deps lint test build
	@echo "ğŸ‰ Full build completed successfully!"