# Test Runner Container for DaaS Integration Tests
FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    jq \
    git \
    bash \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# Install kubectl
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
    && chmod +x kubectl \
    && mv kubectl /usr/local/bin/

# Install Sui CLI
RUN curl -fLJO https://github.com/MystenLabs/sui/releases/latest/download/sui-ubuntu-x86_64.tgz \
    && tar -xzf sui-ubuntu-x86_64.tgz \
    && mv sui /usr/local/bin/ \
    && rm sui-ubuntu-x86_64.tgz

# Set working directory
WORKDIR /app

# Copy requirements first for better caching
COPY testing/requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy test files
COPY testing/integration-tests/ ./tests/
COPY testing/scripts/ ./scripts/
COPY testing/test-data/ ./test-data/

# Copy K3s DaaS security module for testing
COPY k3s-daas/pkg/security/ ./daas_security/

# Set proper permissions
RUN chmod +x scripts/*.sh

# Create test user
RUN useradd -m -u 1001 testuser && \
    chown -R testuser:testuser /app

# Switch to test user
USER testuser

# Set environment variables
ENV PYTHONPATH=/app
ENV PATH=/app/scripts:$PATH

# Default command
CMD ["python", "-m", "pytest", "tests/", "-v"]

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD ["python", "-c", "import sys; sys.exit(0)"]